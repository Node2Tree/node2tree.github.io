<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>哲学图谱</title>
  <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
      }
      .header {
        background-color: #f1f1f1;
        padding: 20px;
        text-align: center;
      }
      .nav-bar {
        background-color: #333;
        overflow: hidden;
      }
      .nav-bar a {
        float: left;
        color: white;
        text-align: center;
        padding: 14px 16px;
        text-decoration: none;
      }
      .nav-bar a:hover {
        background-color: #ddd;
        color: black;
      }
      .motto {
        margin-top: 10px;
        font-style: italic;
      }
      #container { display: flex; height: calc(100vh - 160px); }
      .axis svg {
        background: #f0f0f0;
        display: block;
      }
      #graph-container { flex: 1; position: relative; }
      .tooltip {
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        padding: 8px;
        border-radius: 4px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        display: none;
        font-size: 14px;
        pointer-events: auto;
      }
      .tooltip a {
        color: #0066cc;
        text-decoration: none;
      }
      .tooltip a:hover {
        text-decoration: underline;
      }
      svg text {
        font-size: 12px;
      }
      circle {
        vector-effect: non-scaling-stroke;
        stroke: #333;
        stroke-width: 1;
      }
      line {
        vector-effect: non-scaling-stroke;
      }
  </style>
</head>
<body>
<div class="header">
  <h1>哈三中哲学社团（网站建设中！）</h1>
  <span>随机格言：</span>
  <p class="motto" id="motto"></p>
</div>

<div class="nav-bar">
  <a href="index.html">首页</a>
  <a href="about.html">关于我们</a>
  <a href="library.html">在线文库</a>
  <a href="events.html">活动日历</a>
  <a href="graph.html">哲学图谱</a>
  <a href="contact.html">联系方式</a>
</div>
<div id="container">
  <div class="axis">
    <svg id="axis-svg" width="160" height="1000"></svg>
  </div>
  <div id="graph-container"></div>
</div>
<div class="tooltip" id="tooltip"></div>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
fetch("data/graphData.json")
  .then(response => response.json())
  .then(data => {

const width = window.innerWidth;
const height = window.innerHeight;

const yScale = d3.scaleLinear()
  .domain([-700, 300])
  .range([100, height - 100]);

const svg = d3.select('#graph-container').append('svg')
  .attr('width', width)
  .attr('height', height);

const g = svg.append("g");
const tooltip = d3.select('#tooltip');

// 优化初始位置，按时期分组
data.nodes.forEach((d, i) => {
  if (d.year <= -430) {
    d.x = 200 + (i % 3) * 150;
  } else if (d.year <= -384) {
    d.x = 600 + (i % 2) * 150;
  } else {
    d.x = 900 + (i % 2) * 150;
  }
  d.y = yScale(d.year);
});

const simulation = d3.forceSimulation(data.nodes)
  .force("link", d3.forceLink(data.links).id(d => d.id).distance(250))
  .force("charge", d3.forceManyBody().strength(-500))
  .force("x", d3.forceX().strength(0.05))
  .alphaDecay(0.05);

const link = g.append("g")
  .attr("stroke", "#aaa")
  .attr("stroke-width", 3)
  .selectAll("line")
  .data(data.links)
  .enter().append("line")
  .on("mouseover", (event, d) => {
    d3.select(event.currentTarget)
      .attr("stroke-width", 5)
      .attr("stroke", "#666");
    const [x, y] = d3.pointer(event, svg.node());
    tooltip.style("display", "block")
           .style("left", x + 10 + "px")
           .style("top", y + 10 + "px")
           .html(`<strong>关系说明:</strong><br>${d.description}`);
  })
  .on("mouseout", (event) => {
    d3.select(event.currentTarget)
      .attr("stroke-width", 3)
      .attr("stroke", "#aaa");
    tooltip.style("display", "none");
  });

const node = g.selectAll("circle")
  .data(data.nodes)
  .enter().append("circle")
  .attr("r", 20)
  .attr("fill", "#69b3a2")
  .call(d3.drag()
    .on("start", dragstarted)
    .on("drag", dragged)
    .on("end", dragended))
  .on("click", (event, d) => {
    const [x, y] = d3.pointer(event, svg.node());
    tooltip.style("display", "block")
           .style("left", x + 10 + "px")
           .style("top", y + 10 + "px")
           .html(`<strong>${d.label}</strong><br>年份: ${d.year}<br><a href="https://en.wikipedia.org/wiki/${d.id}" target="_blank">维基百科页面</a>`);
  })
  .on("dblclick", (event, d) => {
    window.open(`https://en.wikipedia.org/wiki/${d.id}`, '_blank');
  });

const label = g.selectAll("text")
  .data(data.nodes)
  .enter().append("text")
  .text(d => d.label)
  .attr("font-size", 12)
  .attr("text-anchor", "middle")
  .attr("dy", -30);

simulation.on("tick", () => {
  data.nodes.forEach(d => {
    if (d.fy == null) d.y = yScale(d.year);
  });
  link.attr("x1", d => d.source.x)
      .attr("y1", d => d.source.y)
      .attr("x2", d => d.target.x)
      .attr("y2", d => d.target.y);
  node.attr("cx", d => d.x)
      .attr("cy", d => d.y);
  label.attr("x", d => d.x)
       .attr("y", d => d.y);
});

function dragstarted(event, d) {
  event.sourceEvent.stopPropagation();
  if (!event.active) simulation.alphaTarget(0.3).restart();
  d.fx = d.x;
}

function dragged(event, d) {
  d.fx = event.x;
  d.fy = event.y;
}

function dragended(event, d) {
  if (!event.active) simulation.alphaTarget(0);
  d.fx = null;
  const targetY = yScale(d.year);
  d.fy = d.y;

  d3.transition()
    .duration(500)
    .tween("rebound", () => {
      const interpolate = d3.interpolate(d.y, targetY);
      return t => {
        d.y = interpolate(t);
        d.fy = d.y;
        node.filter(n => n === d).attr("cy", d.y);
        label.filter(n => n === d).attr("y", d.y);
        link
          .attr("y1", l => l.source.y)
          .attr("y2", l => l.target.y);
      };
    })
    .on("end", () => {
      d.fy = null;
    });
}

const eras = [
  { label: "前苏格拉底时期", from: -700, to: -470 },
  { label: "古典哲学", from: -470, to: -322 },
  { label: "希腊化时期", from: -322, to: 0 },
  { label: "罗马哲学", from: 0, to: 200 },
  { label: "早期中世纪", from: 200, to: 800 },
  { label: "高峰中世纪", from: 800, to: 1300 },
  { label: "文艺复兴前后", from: 1300, to: 1600 },
  { label: "近代哲学", from: 1600, to: 1800 },
  { label: "现代哲学", from: 1800, to: 1950 },
  { label: "当代哲学", from: 1950, to: 2025 }
];

const axisSvg = d3.select('#axis-svg')
  .attr('width', 160)
  .attr('height', height);
const axisG = axisSvg.append("g")
  .attr("transform", "translate(70,0)")
  .attr("font-size", 12);
const axis = d3.axisRight(yScale)
  .ticks(20)
  .tickFormat(d => (d < 0 ? `公元前 ${-d}` : `公元 ${d}`));
axisG.call(axis);

const eraG = axisSvg.append("g").attr("class", "era-labels");
function updateEraLabels(scale) {
  const visible = scale.domain();
  const extent = visible[1] - visible[0];
  let filteredEras = eras;

  if (extent < 2000) {
    filteredEras = eras;
  } else if (extent < 3000) {
    filteredEras = eras.filter(e => e.label !== "前苏格拉底时期" && e.label !== "当代哲学");
  } else {
    filteredEras = eras.filter(e => ["古典哲学", "近代哲学", "现代哲学"].includes(e.label));
  }

  const join = eraG.selectAll("text").data(filteredEras, d => d.label);

  join.enter()
    .append("text")
    .attr("x", 10)
    .attr("y", d => (scale(d.from) + scale(d.to)) / 2)
    .attr("font-size", 13)
    .attr("font-weight", "bold")
    .text(d => d.label)
    .merge(join)
    .attr("y", d => (scale(d.from) + scale(d.to)) / 2);

  join.exit().remove();
}

updateEraLabels(yScale);

const zoom = d3.zoom()
  .filter(event => !event.type.includes("dblclick"))
  .on("zoom", (event) => {
    const transform = event.transform;
    g.attr("transform", transform);

    const scale = transform.k;
    node.attr("r", 20 / scale);
    label
      .style("font-size", `${12 / scale}px`)
      .attr("dy", `${-30 / scale}`);

    const newYScale = transform.rescaleY(yScale);
    axisG.call(d3.axisRight(newYScale)
      .ticks(20)
      .tickFormat(d => (d < 0 ? `公元前 ${-d}` : `公元 ${d}`)));
    updateEraLabels(newYScale);
  });

d3.select('#container').call(zoom);
});
</script>
<script src="files/js/motto.js"></script>
</body>
</html>
