<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>哲学家关系图谱 Demo</title>
  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; font-family: sans-serif; }
    #container { display: flex; height: 100%; }
    .axis svg {
      background: #f0f0f0;
      display: block;
    }
    #graph-container { flex: 1; position: relative; }
    .tooltip {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      padding: 8px;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: none;
      font-size: 14px;
      pointer-events: auto;
    }
    .tooltip a {
      color: #0066cc;
      text-decoration: none;
    }
    .tooltip a:hover {
      text-decoration: underline;
    }
    svg text {
      font-size: 12px;
    }
    circle {
      vector-effect: non-scaling-stroke;
      stroke: #333;
      stroke-width: 1;
    }
    line {
      vector-effect: non-scaling-stroke;
    }
  </style>
</head>
<body>
<div id="container">
  <div class="axis">
    <svg id="axis-svg" width="160" height="1000"></svg>
  </div>
  <div id="graph-container"></div>
</div>
<div class="tooltip" id="tooltip"></div>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const data = {
  nodes: [
    { id: 'Thales', label: '泰勒斯 - 水是万物的本原', year: -585 },
    { id: 'Anaximander', label: '阿纳克西曼德 - 无定形 Apeiron', year: -570 },
    { id: 'Anaximenes', label: '阿纳克西美尼 - 气为本原', year: -550 },
    { id: 'Heraclitus', label: '赫拉克利特 - 火与流变，logos', year: -500 },
    { id: 'Xenophanes', label: '色诺芬尼 - 存在转向', year: -520 },
    { id: 'Parmenides', label: '巴门尼德 - 存在是一', year: -480 },
    { id: 'Empedocles', label: '恩培多克勒 - 四根与爱/冲突', year: -460 },
    { id: 'Anaxagoras', label: '阿那克萨戈拉 - 种子与 Nous', year: -460 },
    { id: 'Democritus', label: '德谟克里特 - 原子论', year: -430 },
    { id: 'Socrates', label: '苏格拉底 - 伦理辩证法', year: -470 },
    { id: 'Plato', label: '柏拉图 - 理念论', year: -428 },
    { id: 'Aristotle', label: '亚里士多德 - 实体论', year: -384 },
    { id: 'Zeno_of_Citium', label: '芝诺（斯多葛派） - 物质性与 logos', year: -300 },
    { id: 'Epicurus', label: '伊壁鸠鲁 - 原子偶然性，快乐主义', year: -310 },
    { id: 'Pyrrho', label: '皮浪（怀疑派） - 悬搁判断', year: -315 },
    { id: 'Plotinus', label: '普罗提诺（新柏拉图主义） - 太一流溢说', year: 240 }
  ],
  links: [
    { source: 'Thales', target: 'Anaximander', description: '阿纳克西曼德是泰勒斯的学生' },
    { source: 'Anaximander', target: 'Anaximenes', description: '阿纳克西美尼是阿纳克西曼德的学生' },
    { source: 'Xenophanes', target: 'Parmenides', description: '巴门尼德继承色诺芬尼的存在论转向' },
    { source: 'Heraclitus', target: 'Parmenides', description: '赫拉克利特与巴门尼德思想对立' },
    { source: 'Parmenides', target: 'Empedocles', description: '恩培多克勒受巴门尼德影响' },
    { source: 'Parmenides', target: 'Anaxagoras', description: '阿那克萨戈拉受巴门尼德影响' },
    { source: 'Parmenides', target: 'Democritus', description: '德谟克里特受巴门尼德影响' },
    { source: 'Socrates', target: 'Plato', description: '柏拉图是苏格拉底的学生' },
    { source: 'Plato', target: 'Aristotle', description: '亚里士多德是柏拉图的学生' },
    { source: 'Heraclitus', target: 'Zeno_of_Citium', description: '斯多葛派继承赫拉克利特的 logos' },
    { source: 'Socrates', target: 'Zeno_of_Citium', description: '斯多葛派受苏格拉底伦理学影响' },
    { source: 'Democritus', target: 'Epicurus', description: '伊壁鸠鲁继承德谟克里特原子论' },
    { source: 'Zeno_of_Citium', target: 'Pyrrho', description: '皮浪批判斯多葛派的 logos' },
    { source: 'Epicurus', target: 'Pyrrho', description: '皮浪批判伊壁鸠鲁的原子论' },
    { source: 'Plato', target: 'Plotinus', description: '普罗提诺继承柏拉图理念论' }
  ]
};

const width = window.innerWidth;
const height = window.innerHeight;

const yScale = d3.scaleLinear()
  .domain([-700, 300])
  .range([100, height - 100]);

const svg = d3.select('#graph-container').append('svg')
  .attr('width', width)
  .attr('height', height);

const g = svg.append("g");
const tooltip = d3.select('#tooltip');

// 优化初始位置，按时期分组
data.nodes.forEach((d, i) => {
  if (d.year <= -430) {
    d.x = 200 + (i % 3) * 150;
  } else if (d.year <= -384) {
    d.x = 600 + (i % 2) * 150;
  } else {
    d.x = 900 + (i % 2) * 150;
  }
  d.y = yScale(d.year);
});

const simulation = d3.forceSimulation(data.nodes)
  .force("link", d3.forceLink(data.links).id(d => d.id).distance(250))
  .force("charge", d3.forceManyBody().strength(-500))
  .force("x", d3.forceX().strength(0.05))
  .alphaDecay(0.05);

const link = g.append("g")
  .attr("stroke", "#aaa")
  .attr("stroke-width", 3)
  .selectAll("line")
  .data(data.links)
  .enter().append("line")
  .on("mouseover", (event, d) => {
    d3.select(event.currentTarget)
      .attr("stroke-width", 5)
      .attr("stroke", "#666");
    const [x, y] = d3.pointer(event, svg.node());
    tooltip.style("display", "block")
           .style("left", x + 10 + "px")
           .style("top", y + 10 + "px")
           .html(`<strong>关系说明:</strong><br>${d.description}`);
  })
  .on("mouseout", (event) => {
    d3.select(event.currentTarget)
      .attr("stroke-width", 3)
      .attr("stroke", "#aaa");
    tooltip.style("display", "none");
  });

const node = g.selectAll("circle")
  .data(data.nodes)
  .enter().append("circle")
  .attr("r", 20)
  .attr("fill", "#69b3a2")
  .call(d3.drag()
    .on("start", dragstarted)
    .on("drag", dragged)
    .on("end", dragended))
  .on("click", (event, d) => {
    const [x, y] = d3.pointer(event, svg.node());
    tooltip.style("display", "block")
           .style("left", x + 10 + "px")
           .style("top", y + 10 + "px")
           .html(`<strong>${d.label}</strong><br>年份: ${d.year}<br><a href="https://en.wikipedia.org/wiki/${d.id}" target="_blank">维基百科页面</a>`);
  })
  .on("dblclick", (event, d) => {
    window.open(`https://en.wikipedia.org/wiki/${d.id}`, '_blank');
  });

const label = g.selectAll("text")
  .data(data.nodes)
  .enter().append("text")
  .text(d => d.label)
  .attr("font-size", 12)
  .attr("text-anchor", "middle")
  .attr("dy", -30);

simulation.on("tick", () => {
  data.nodes.forEach(d => {
    if (d.fy == null) d.y = yScale(d.year);
  });
  link.attr("x1", d => d.source.x)
      .attr("y1", d => d.source.y)
      .attr("x2", d => d.target.x)
      .attr("y2", d => d.target.y);
  node.attr("cx", d => d.x)
      .attr("cy", d => d.y);
  label.attr("x", d => d.x)
       .attr("y", d => d.y);
});

function dragstarted(event, d) {
  event.sourceEvent.stopPropagation();
  if (!event.active) simulation.alphaTarget(0.3).restart();
  d.fx = d.x;
}

function dragged(event, d) {
  d.fx = event.x;
  d.fy = event.y;
}

function dragended(event, d) {
  if (!event.active) simulation.alphaTarget(0);
  d.fx = null;
  const targetY = yScale(d.year);
  d.fy = d.y;

  d3.transition()
    .duration(500)
    .tween("rebound", () => {
      const interpolate = d3.interpolate(d.y, targetY);
      return t => {
        d.y = interpolate(t);
        d.fy = d.y;
        node.filter(n => n === d).attr("cy", d.y);
        label.filter(n => n === d).attr("y", d.y);
        link
          .attr("y1", l => l.source.y)
          .attr("y2", l => l.target.y);
      };
    })
    .on("end", () => {
      d.fy = null;
    });
}

const eras = [
  { label: "前苏格拉底时期", from: -700, to: -470 },
  { label: "古典哲学", from: -470, to: -322 },
  { label: "希腊化时期", from: -322, to: 0 },
  { label: "罗马哲学", from: 0, to: 200 },
  { label: "早期中世纪", from: 200, to: 800 },
  { label: "高峰中世纪", from: 800, to: 1300 },
  { label: "文艺复兴前后", from: 1300, to: 1600 },
  { label: "近代哲学", from: 1600, to: 1800 },
  { label: "现代哲学", from: 1800, to: 1950 },
  { label: "当代哲学", from: 1950, to: 2025 }
];

const axisSvg = d3.select('#axis-svg')
  .attr('width', 160)
  .attr('height', height);
const axisG = axisSvg.append("g")
  .attr("transform", "translate(70,0)")
  .attr("font-size", 12);
const axis = d3.axisRight(yScale)
  .ticks(20)
  .tickFormat(d => (d < 0 ? `公元前 ${-d}` : `公元 ${d}`));
axisG.call(axis);

const eraG = axisSvg.append("g").attr("class", "era-labels");
function updateEraLabels(scale) {
  const visible = scale.domain();
  const extent = visible[1] - visible[0];
  let filteredEras = eras;

  if (extent < 2000) {
    filteredEras = eras;
  } else if (extent < 3000) {
    filteredEras = eras.filter(e => e.label !== "前苏格拉底时期" && e.label !== "当代哲学");
  } else {
    filteredEras = eras.filter(e => ["古典哲学", "近代哲学", "现代哲学"].includes(e.label));
  }

  const join = eraG.selectAll("text").data(filteredEras, d => d.label);

  join.enter()
    .append("text")
    .attr("x", 10)
    .attr("y", d => (scale(d.from) + scale(d.to)) / 2)
    .attr("font-size", 13)
    .attr("font-weight", "bold")
    .text(d => d.label)
    .merge(join)
    .attr("y", d => (scale(d.from) + scale(d.to)) / 2);

  join.exit().remove();
}

updateEraLabels(yScale);

const zoom = d3.zoom()
  .filter(event => !event.type.includes("dblclick"))
  .on("zoom", (event) => {
    const transform = event.transform;
    g.attr("transform", transform);

    const scale = transform.k;
    node.attr("r", 20 / scale);
    label
      .style("font-size", `${12 / scale}px`)
      .attr("dy", `${-30 / scale}`);

    const newYScale = transform.rescaleY(yScale);
    axisG.call(d3.axisRight(newYScale)
      .ticks(20)
      .tickFormat(d => (d < 0 ? `公元前 ${-d}` : `公元 ${d}`)));
    updateEraLabels(newYScale);
  });

d3.select('#container').call(zoom);
</script>
</body>
</html>
